extern "C" %{
/**
 * @copyright (c) 2023-2025     Saint Louis University (SLU)
 * @copyright (c) 2023-2025     Massachusetts Institute of Technology (MIT)
 * @copyright (c) 2023-2025     Nvidia Corporation
 * @copyright (c) 2018-2025     King Abdullah University of Science and Technology (KAUST)
 * @copyright (c) 2018-2023     The University of Tennessee and The University of Tennessee Research Foundation
 *                              All rights reserved.
 **/

#include "hicma_parsec.h"
%}

/**
 * @file Lapack_to_Tile.jdf
 * @brief PaRSEC kernel for converting LAPACK matrix to tiled format (double precision)
 * 
 * This kernel converts a contiguous LAPACK-style matrix to a distributed tiled matrix
 * format. It handles the conversion from the column-major format used by LAPACK routines
 * to the tile-based storage format used by PaRSEC.
 * 
 * The conversion process involves:
 * 1. Iterating over all tiles in the matrix
 * 2. Calculating proper tile dimensions (handling edge cases)
 * 3. Computing source addresses in the LAPACK matrix
 * 4. Copying data from LAPACK layout to tile layout using optimized BLAS routines
 */

// Task parameters: tiled matrix descriptor, source data, and grid dimensions
descA             [ type = "parsec_tiled_matrix_t *" ]  // Destination tiled matrix descriptor
Zobs              [ type = "double *" ]                 // Source LAPACK matrix buffer
P                 [ type = "int" ]                      // Process grid row dimension
Q                 [ type = "int" ]                      // Process grid column dimension

// Task iteration over all tiles in the matrix
Read(m, n)

// Iterate over all tiles in the matrix
// m: tile row index, n: tile column index
m = 0 .. descA->lmt-1
n = 0 .. descA->lnt-1 

: descA(m, n)

// Read-write access to tile data
RW A <- descA(m, n) 
     -> descA(m, n)

BODY
{
    int tempmm, tempnn, ldam;
    
    // Calculate actual tile dimensions, handling edge tiles that may be smaller
    // For the last tile in each dimension, use remaining elements
    tempmm = ((m)==((descA->mt)-1)) ? ((descA->m)-(m*(descA->mb))) : (descA->mb);
    tempnn = ((n)==((descA->nt)-1)) ? ((descA->n)-(n*(descA->nb))) : (descA->nb);
    
    // Get leading dimension of destination tile
    ldam = BLKLDD( descA, m );

    // Calculate source address in LAPACK matrix using column-major indexing
    void *Z0 = (void *)Zobs + parsec_getaddr_cm(descA, m, n, P, Q);
    
    // Copy data from LAPACK column-major layout to tile layout
    // Uses optimized BLAS routine for maximum performance
    CORE_dlacpy(PlasmaUpperLower, tempmm, tempnn,
               (double*)Z0, descA->llm,
                         A , ldam);
}
END


extern "C" %{


/**
 * @brief Create new taskpool for LAPACK to tile conversion (double precision)
 * 
 * This function creates and configures a PaRSEC taskpool for converting
 * a LAPACK matrix to distributed tiled format. The taskpool manages the
 * parallel execution of LAPACK-to-tile conversion tasks across the process grid.
 * 
 * @param [in] dcA:    Destination tiled matrix descriptor (already distributed and allocated)
 * @param [in] Zobs:   Source LAPACK matrix buffer (pre-allocated)
 * @param [in] P:      Process grid row dimension
 * @param [in] Q:      Process grid column dimension
 * @return Pointer to the created parsec taskpool object for scheduling
 */
parsec_taskpool_t*
hicma_parsec_Lapack_to_Tile_New(parsec_tiled_matrix_t *dcA, double *Zobs, int P, int Q) 
{
    parsec_taskpool_t* Lapack_to_Tile_taskpool;
    parsec_Lapack_to_Tile_taskpool_t* taskpool = NULL;

    // Create new taskpool instance with input parameters
    taskpool = parsec_Lapack_to_Tile_new(dcA, Zobs, P, Q); 
    Lapack_to_Tile_taskpool = (parsec_taskpool_t*)taskpool;

    // Configure arena for double precision data with proper alignment
    // This ensures optimal memory access patterns for double precision operations
    parsec_add2arena(&taskpool->arenas_datatypes[PARSEC_Lapack_to_Tile_DEFAULT_ADT_IDX],
                            parsec_datatype_double_t, PARSEC_MATRIX_FULL,
                            1, dcA->mb, dcA->nb, dcA->mb,
                            PARSEC_ARENA_ALIGNMENT_SSE, -1 );

    return Lapack_to_Tile_taskpool;
}

/**
 * @brief Destroy taskpool and clean up resources
 * 
 * This function properly cleans up all resources associated with the
 * LAPACK-to-tile conversion taskpool, including arena memory and
 * taskpool structures.
 * 
 * @param [inout] taskpool: Pointer to the parsec taskpool object to destroy
 */
void hicma_parsec_Lapack_to_Tile_Destruct(parsec_taskpool_t *taskpool)
{
    parsec_Lapack_to_Tile_taskpool_t *Lapack_to_Tile_taskpool = (parsec_Lapack_to_Tile_taskpool_t *)taskpool;
    
    // Clean up arena resources to prevent memory leaks
    parsec_del2arena(&Lapack_to_Tile_taskpool->arenas_datatypes[PARSEC_Lapack_to_Tile_DEFAULT_ADT_IDX]);
    
    // Free taskpool memory and associated structures
    parsec_taskpool_free(taskpool);
}

/**
 * @brief Execute LAPACK to tile conversion (double precision)
 *
 * This is the main interface function for converting a LAPACK matrix to distributed
 * tiled format. It creates a taskpool, schedules the conversion tasks, executes them
 * in parallel, and cleans up resources.
 *
 * @param [in] parsec: PaRSEC context for task scheduling and execution
 * @param [inout] dcA: Destination tiled matrix descriptor (already distributed and allocated)
 * @param [in] Zobs: Source LAPACK matrix buffer (pre-allocated)
 * @param [in] P: Process grid row dimension
 * @param [in] Q: Process grid column dimension
 * @return 0 on success, error code on failure
 */
int hicma_parsec_Lapack_to_Tile(parsec_context_t *parsec,
		parsec_tiled_matrix_t *dcA, double *Zobs, int P, int Q) 
{
    parsec_taskpool_t *parsec_Lapack_to_Tile = NULL;
    
    // Create taskpool for conversion with input parameters
    parsec_Lapack_to_Tile = hicma_parsec_Lapack_to_Tile_New(dcA, Zobs, P, Q); 

    if( parsec_Lapack_to_Tile != NULL ){
        // Schedule conversion tasks to the PaRSEC context
        parsec_context_add_taskpool(parsec, parsec_Lapack_to_Tile);
        
        // Start task execution and wait for completion
        parsec_context_start(parsec);
        parsec_context_wait(parsec);
        
        // Clean up taskpool resources
        hicma_parsec_Lapack_to_Tile_Destruct(parsec_Lapack_to_Tile);
    }

    return 0;
}

%}

