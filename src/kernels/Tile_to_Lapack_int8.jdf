extern "C" %{
/**
 * @copyright (c) 2023-2025     Saint Louis University (SLU)
 * @copyright (c) 2023-2025     Massachusetts Institute of Technology (MIT)
 * @copyright (c) 2023-2025     Nvidia Corporation
 * @copyright (c) 2018-2025     King Abdullah University of Science and Technology (KAUST)
 * @copyright (c) 2018-2023     The University of Tennessee and The University of Tennessee Research Foundation
 *                              All rights reserved.
 **/

#include "hicma_parsec.h"

/**
 * @brief 8-bit integer matrix copy function for tile-to-LAPACK conversion
 * 
 * This function copies matrix elements from a tile layout to LAPACK column-major layout
 * for 8-bit integer data. It performs the conversion element by element, handling the
 * different memory layouts between the tile-based storage and LAPACK format.
 * 
 * @param [in] uplo: Upper/lower triangle specification (not used in this implementation)
 * @param [in] tempmm: Number of rows in the tile
 * @param [in] tempnn: Number of columns in the tile
 * @param [in] A: Source tile data (tile layout)
 * @param [in] lda: Leading dimension of source tile
 * @param [out] Z0: Destination LAPACK matrix buffer (column-major layout)
 * @param [in] ldz0: Leading dimension of destination matrix
 */
void i8lacpy(int uplo, int tempmm, int tempnn, int8_t *A, int lda, int8_t *Z0, int ldz0){
      
    // Copy matrix elements from tile layout to LAPACK column-major layout
    // Iterate over all elements in the tile
    for(int i=0;i<tempmm;i++){
       for(int j=0;j<tempnn;j++){
           // Copy element from source tile to destination LAPACK matrix
           // Note: LAPACK uses column-major indexing (j*ldz0+i)
           Z0[j*ldz0+i] = (int8_t) A[j*lda+i];
       }
    }
}

%}

/**
 * @file Tile_to_Lapack_int8.jdf
 * @brief PaRSEC kernel for converting tiled matrix to LAPACK format (8-bit integer precision)
 * 
 * This kernel converts a distributed tiled matrix to a contiguous LAPACK-style
 * matrix layout for 8-bit integer data. It handles the conversion from the tile-based
 * storage format used by PaRSEC to the column-major format expected by LAPACK routines.
 * 
 * This version processes all tiles in the matrix, making it suitable for general
 * (non-symmetric) matrices.
 */

// Input parameters for 8-bit integer tile-to-LAPACK conversion
descA             [ type = "parsec_tiled_matrix_t *" ]  // Source tiled matrix descriptor
Zobs              [ type = "int8_t *" ]                // Destination LAPACK matrix buffer
P                 [ type = "int" ]                      // Process grid row dimension
Q                 [ type = "int" ]                      // Process grid column dimension

Read(m, n)

// Iterate over all tiles in the matrix
// m: tile row index, n: tile column index
m = 0 .. descA->lmt-1
n = 0 .. descA->lnt-1

: descA(m, n)

READ A <- descA(m, n)

BODY
{
       int tempmm, tempnn, ldam;
       
       // Calculate actual tile dimensions, handling edge tiles that may be smaller
       // For the last tile in each dimension, use remaining elements
       tempmm = ((m)==((descA->mt)-1)) ? ((descA->m)-(m*(descA->mb))) : (descA->mb);
       tempnn = ((n)==((descA->nt)-1)) ? ((descA->n)-(n*(descA->nb))) : (descA->nb);
       
       // Get leading dimension of source tile
       ldam = BLKLDD( descA, m );

       // Calculate destination address in LAPACK matrix using column-major indexing
       void *Z0 = (void *)Zobs + parsec_getaddr_cm(descA, m, n, P, Q);
       
       // Copy tile data from tile layout to LAPACK column-major layout
       // Uses custom 8-bit integer copy function for int8_t data type
       i8lacpy(PlasmaUpperLower, tempmm, tempnn,
                  A, ldam, (int8_t*)Z0, descA->llm);
               
}
END


extern "C" %{


/**
 * @brief Create new taskpool for 8-bit integer tile-to-LAPACK conversion
 * 
 * This function creates and configures a PaRSEC taskpool for converting
 * a distributed tiled matrix to LAPACK format for 8-bit integer data. The taskpool
 * manages the parallel execution of tile-to-LAPACK conversion tasks across
 * the process grid, specifically handling int8_t data types.
 * 
 * @param [in] dcA:    Source tiled matrix descriptor (already distributed and allocated)
 * @param [in] Zobs:   Destination LAPACK matrix buffer (pre-allocated)
 * @param [in] P:      Process grid row dimension
 * @param [in] Q:      Process grid column dimension
 * @return Pointer to the created parsec taskpool object for scheduling
 */
parsec_taskpool_t*
hicma_parsec_Tile_to_Lapack_int8_New(parsec_tiled_matrix_t *dcA, int8_t *Zobs, int P, int Q)
{
    parsec_taskpool_t* Tile_to_Lapack_int8_taskpool;
    parsec_Tile_to_Lapack_int8_taskpool_t* taskpool = NULL;

    // Create new taskpool instance with input parameters
    taskpool = parsec_Tile_to_Lapack_int8_new(dcA, Zobs, P, Q);
    Tile_to_Lapack_int8_taskpool = (parsec_taskpool_t*)taskpool;

    // Configure arena for 8-bit integer data with proper alignment
    // This ensures optimal memory access patterns for int8_t operations
    parsec_add2arena(&taskpool->arenas_datatypes[PARSEC_Tile_to_Lapack_int8_DEFAULT_ADT_IDX],
                            parsec_datatype_int8_t, PARSEC_MATRIX_FULL,
                            1, dcA->mb, dcA->nb, dcA->mb,
                            PARSEC_ARENA_ALIGNMENT_SSE, -1 );

    return Tile_to_Lapack_int8_taskpool;
}

/**
 * @brief Destroy taskpool and clean up resources
 * 
 * This function properly cleans up all resources associated with the
 * 8-bit integer tile-to-LAPACK conversion taskpool, including arena memory and
 * taskpool structures.
 * 
 * @param [inout] taskpool: Pointer to the parsec taskpool object to destroy
 */
void hicma_parsec_Tile_to_Lapack_int8_Destruct(parsec_taskpool_t *taskpool)
{
    parsec_Tile_to_Lapack_int8_taskpool_t *Tile_to_Lapack_int8_taskpool = (parsec_Tile_to_Lapack_int8_taskpool_t *)taskpool;
    
    // Clean up arena resources to prevent memory leaks
    parsec_del2arena(&Tile_to_Lapack_int8_taskpool->arenas_datatypes[PARSEC_Tile_to_Lapack_int8_DEFAULT_ADT_IDX]);
    
    // Free taskpool memory and associated structures
    parsec_taskpool_free(taskpool);
}

/**
 * @brief Execute 8-bit integer tile-to-LAPACK conversion
 *
 * This is the main interface function for converting a distributed tiled matrix
 * to LAPACK format for 8-bit integer data. It creates a taskpool, schedules the
 * conversion tasks, executes them in parallel, and cleans up resources.
 *
 * @param [in] parsec: PaRSEC context for task scheduling and execution
 * @param [in] dcA: Source tiled matrix descriptor (already distributed and allocated)
 * @param [in] Zobs: Destination LAPACK matrix buffer (pre-allocated)
 * @param [in] P: Process grid row dimension
 * @param [in] Q: Process grid column dimension
 * @return 0 on success, error code on failure
 */
int hicma_parsec_Tile_to_Lapack_int8(parsec_context_t *parsec,
                parsec_tiled_matrix_t *dcA, int8_t *Zobs, int P, int Q)
{
    parsec_taskpool_t *parsec_Tile_to_Lapack_int8 = NULL;
    
    // Create taskpool for conversion with input parameters
    parsec_Tile_to_Lapack_int8 = hicma_parsec_Tile_to_Lapack_int8_New(dcA, Zobs, P, Q);

    if( parsec_Tile_to_Lapack_int8 != NULL ){
        // Schedule conversion tasks to the PaRSEC context
        parsec_context_add_taskpool(parsec, parsec_Tile_to_Lapack_int8);
        
        // Start task execution and wait for completion
        parsec_context_start(parsec);
        parsec_context_wait(parsec);
        
        // Clean up taskpool resources
        hicma_parsec_Tile_to_Lapack_int8_Destruct(parsec_Tile_to_Lapack_int8);
    }

    return 0;
}

%}
